{% extends 'index.html' %}
{% load static %}
{% load custom_filters %}

{% block title %} Revue de Performance de {{ review.employee.get_full_name }} {% endblock %}

{% block navigation1 %}
    {% if not request.user.is_simple_employee %}
      <nav class="navbar navbar-vertical navbar-expand-lg" style="display:none;">
        <div class="collapse navbar-collapse" id="navbarVerticalCollapse">
          <!-- scrollbar removed-->
          <div class="navbar-vertical-content">
            <ul class="navbar-nav flex-column" id="navbarVerticalNav">
              <li class="nav-item">
                <!-- parent pages-->
                <div class="nav-item-wrapper"><a class="nav-link dropdown-indicator label-1" href="#nv-home" role="button" data-bs-toggle="collapse" aria-expanded="true" aria-controls="nv-home">
                    <div class="d-flex align-items-center">
                      <div class="dropdown-indicator-icon-wrapper"><span class="fas fa-caret-right dropdown-indicator-icon"></span></div><span class="nav-link-icon"><span data-feather="pie-chart"></span></span><span class="nav-link-text">Tableau de board</span>
                    </div>
                  </a>
                  <div class="parent-wrapper label-1">
                    <ul class="nav collapse parent show" data-bs-parent="#navbarVerticalCollapse" id="nv-home">
                      <li class="collapsed-nav-item-title d-none">Dashboard</li>
                      <li class="nav-item"><a class="nav-link {% if active_link == 1 %}active{% endif %}" href="{%  url 'dashboard:home' %}">
                          <div class="d-flex align-items-center"><span class="nav-link-text">Accueil</span></div>
                        </a><!-- more inner pages-->
                      </li>


                      <li class="nav-item"><a class="nav-link {% if active_link == 3 %}active{% endif %}" href="{% url 'goals:element-liste' %}">
                              <div class="d-flex align-items-center"><span class="nav-link-text">Liste Element evaluation</span></div>
                            </a><!-- more inner pages-->
                      </li>

                      {% if request.user.is_hr %}
                          <li class="nav-item"><a class="nav-link {% if active_link == 6 %}active{% endif %}" href="{% url 'course:trainingcourse-add' %}">
                              <div class="d-flex align-items-center"><span class="nav-link-text"> Ajouter un cours </span></div>
                            </a><!-- more inner pages-->
                          </li>
                      {% endif %}

                      {%  if request.user.is_manager %}
                          <li class="nav-item"><a class="nav-link {% if active_link == 3 %}active{% endif %}" href="{% url 'Skill_Training:formations_list' %}">
                                  <div class="d-flex align-items-center"><span class="nav-link-text">Agent en formation</span></div>
                                </a><!-- more inner pages-->
                          </li>
                          <li class="nav-item"><a class="nav-link {% if active_link == 4 %}active{% endif %}" href="{% url 'goals:create' %}">
                              <div class="d-flex align-items-center"><span class="nav-link-text">Fixer un objectif</span></div>
                            </a><!-- more inner pages-->
                          </li>
                          <li class="nav-item"><a class="nav-link {% if active_link == 4 %}active{% endif %}" href="{% url 'goals:list' %}">
                              <div class="d-flex align-items-center"><span class="nav-link-text">Liste d'objectif</span></div>
                            </a><!-- more inner pages-->
                          </li>
                          <li class="nav-item"><a class="nav-link {% if active_link == 4 %}active{% endif %}" href="{% url 'goals:perform-list' %}">
                              <div class="d-flex align-items-center"><span class="nav-link-text">Liste d'evaluation</span></div>
                            </a><!-- more inner pages-->
                          </li>
                          <li class="nav-item"><a class="nav-link {% if active_link == 4 %}active{% endif %}" href="{% url 'goals:perform-create' %}">
                              <div class="d-flex align-items-center"><span class="nav-link-text">Evaluer un agent</span></div>
                            </a><!-- more inner pages-->
                          </li>
                      {% endif  %}

                    </ul>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div class="navbar-vertical-footer"><button class="btn navbar-vertical-toggle border-0 fw-semibold w-100 white-space-nowrap d-flex align-items-center"><span class="uil uil-left-arrow-to-left fs-8"></span><span class="uil uil-arrow-from-right fs-8"></span><span class="navbar-vertical-footer-text ms-2">Collapsed View</span></button></div>
      </nav>

    {% endif %}
{% endblock %}

{% block content %}
<div class="content">
    <div class="card-header">
        <h3 class="mb-0">Revue de Performance de {{ review.employee.get_full_name }}</h3>
        <p class="text-muted mb-0">Évaluée le {{ review.review_date|date:"d M Y" }} par {{ review.reviewer.get_full_name|default:"Administrateur" }}</p>
    </div>
    <div class="goals-container">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Scores par Domaine</h5>
                <div class="row g-4">
                    {% for score_field, label in review.get_score_fields %}
                        {% with score_value=review|get_attribute:score_field %}
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">{{ label }}</label>
                            {% if score_value %}
                                {% with percentage=score_value|div:5|mul:100 %}
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ percentage }}%"
                                         aria-valuenow="{{ percentage|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100">
                                        <span class="fs-9 text-dark fw-bold">{{ review|get_attribute_display:score_field }}</span>
                                    </div>
                                </div>
                                {% endwith %}
                            {% else %}
                                <p class="text-muted">Score non attribué.</p>
                            {% endif %}
                        </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Commentaires Généraux</h5>
                <p class="card-text">{{ review.comments|linebreaks }}</p>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Formations Recommandées</h5>
                {% if review.formations_recommender.all %}
                <div class="list-group">
                    {% for course in review.formations_recommender.all %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ course.title }}</h6>
                            <p class="mb-1 text-muted">{{ course.provider }} - {{ course.duration_hours }} heures</p>
                            <div>
                                {% for skill in course.skills_covered.all %}
                                    <span class="badge badge-skill">{{ skill.name }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <a class="btn btn-phoenix-info" href="{% url 'course:inscrire_employee'  course.pk %}">S'inscrire</a>


                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">Aucune formation n'a été recommandée dans cette évaluation.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}